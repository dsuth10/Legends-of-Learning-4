{% extends "base.html" %}

{% block title %}Shop{% endblock %}

{% macro item_card(item) %}
<div class="card h-100 shop-item-card" 
     data-category="{{ item.category }}" 
     data-tier="{{ item.tier }}" 
     data-unlocked="{{ 'true' if item.unlocked else 'false' }}"
     data-name="{{ item.name|lower }}"
     data-description="{{ item.description|lower }}"
     style="display:block;"
     data-item-id="{{ item.id }}">
    <img src="{{ item.image }}" class="card-img-top" alt="{{ item.name }}" style="height:120px;object-fit:contain;">
    <div class="card-body d-flex flex-column">
        <h5 class="card-title">{{ item.name }}</h5>
        <span class="badge bg-success mb-2">Price: {{ item.price }} gold</span>
        {% if item.owned %}
            <span class="badge bg-info mb-2">Owned</span>
        {% endif %}
        {% if not item.can_afford and not item.owned %}
            <span class="badge bg-danger mb-2">Not enough gold</span>
        {% endif %}
        {% if not item.unlocked and not item.owned %}
            <span class="badge bg-secondary mb-2">Locked</span>
        {% endif %}
        <button class="btn btn-primary w-100" {% if not item.can_buy %}disabled{% endif %}>Buy</button>
    </div>
</div>
{% endmacro %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Shop</h2>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-warning text-dark fs-5">Gold: {{ main_character.gold if main_character else 0 }}</span>
            <a href="{{ url_for('auth.logout') }}" 
               class="btn btn-outline-secondary btn-sm"
               title="Logout"
               aria-label="Logout">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </div>
    <!-- Filters row -->
    <div class="row mb-3">
        <div class="col-md-4 mb-2">
            <select class="form-select" id="filter-category">
                <option value="">All Categories</option>
                <option value="equipment">Equipment</option>
                <option value="consumable">Consumables</option>
                <option value="ability">Abilities</option>
            </select>
        </div>
        <div class="col-md-4 mb-2">
            <select class="form-select" id="filter-tier">
                <option value="">All Tiers</option>
                <option value="1">Tier 1</option>
                <option value="2">Tier 2</option>
                <option value="3">Tier 3</option>
            </select>
        </div>
        <div class="col-md-4 mb-2">
            <input type="text" class="form-control" id="search-items" placeholder="Search items...">
        </div>
    </div>
    <!-- Item grid -->
    <div class="row" id="shop-items-grid">
        {% for item in items %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4 shop-item-col">
            {{ item_card(item) }}
        </div>
        {% endfor %}
    </div>
    <div id="no-items-message" class="text-center text-muted mt-4" style="display:none;">No items found for the selected filters.</div>
</div>
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    function filterShopItems() {
        var category = document.getElementById('filter-category').value;
        var tier = document.getElementById('filter-tier').value;
        var search = document.getElementById('search-items').value.trim().toLowerCase();
        var cards = document.querySelectorAll('.shop-item-col');
        var anyVisible = false;
        cards.forEach(function(col) {
            var card = col.querySelector('.shop-item-card');
            var matchesCategory = !category || card.getAttribute('data-category') === category;
            var matchesTier = !tier || card.getAttribute('data-tier') === tier;
            var matchesSearch = !search || card.getAttribute('data-name').includes(search) || card.getAttribute('data-description').includes(search);
            var isUnlocked = card.getAttribute('data-unlocked') === 'true';
            if (matchesCategory && matchesTier && matchesSearch && isUnlocked) {
                col.style.display = '';
                anyVisible = true;
            } else {
                col.style.display = 'none';
            }
        });
        document.getElementById('no-items-message').style.display = anyVisible ? 'none' : '';
    }
    document.getElementById('filter-category').addEventListener('change', filterShopItems);
    document.getElementById('filter-tier').addEventListener('change', filterShopItems);
    document.getElementById('search-items').addEventListener('input', filterShopItems);

    // --- Buy button logic ---
    function showShopMessage(msg, isError) {
        var msgDiv = document.getElementById('shop-message');
        if (!msgDiv) {
            msgDiv = document.createElement('div');
            msgDiv.id = 'shop-message';
            msgDiv.className = 'alert mt-3';
            document.querySelector('.container.mt-5').prepend(msgDiv);
        }
        msgDiv.textContent = msg;
        msgDiv.classList.toggle('alert-success', !isError);
        msgDiv.classList.toggle('alert-danger', !!isError);
        msgDiv.style.display = '';
        setTimeout(function() { msgDiv.style.display = 'none'; }, 3000);
    }

    // Use event delegation on the shop items container
    // Script is at bottom of page, so DOM should be ready
    (function() {
        var shopGrid = document.getElementById('shop-items-grid');
        if (!shopGrid) {
            console.error('shop-items-grid not found');
            return;
        }
        
        shopGrid.addEventListener('click', function(e) {
            var btn = e.target.closest('.btn.btn-primary');
            if (!btn || btn.disabled || btn.dataset.processing === 'true') return;
            
            var card = btn.closest('.shop-item-card');
            if (!card) {
                console.warn('Could not find shop-item-card for button');
                return;
            }
            
            var itemId = card.getAttribute('data-item-id');
            var itemType = card.getAttribute('data-category');
            
            if (!itemId) {
                console.error('Item ID not found on card');
                return;
            }
            
            // Prevent multiple clicks
            btn.dataset.processing = 'true';
            btn.disabled = true;
            var originalText = btn.textContent;
            btn.textContent = 'Processing...';
            
            // Make purchase request
            fetch('/student/shop/buy', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ item_id: itemId, item_type: itemType }),
                credentials: 'same-origin' // Include cookies for session
            })
            .then(function(res) {
                // Check if response is ok before parsing JSON
                if (!res.ok) {
                    // Try to parse error response as JSON
                    return res.json().then(function(data) {
                        throw new Error(data.message || `HTTP ${res.status}: ${res.statusText}`);
                    }).catch(function(parseError) {
                        // If JSON parsing fails, throw HTTP error
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    });
                }
                // Parse successful response
                return res.json();
            })
            .then(function(data) {
                // Validate response structure
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid response from server');
                }
                
                if (data.success) {
                    // Update gold display
                    var goldBadge = document.querySelector('.badge.bg-warning');
                    if (goldBadge && data.character && typeof data.character.gold === 'number') {
                        goldBadge.textContent = 'Gold: ' + data.character.gold;
                    }
                    
                    // Mark as owned
                    if (!card.querySelector('.badge.bg-info')) {
                        var badge = document.createElement('span');
                        badge.className = 'badge bg-info mb-2';
                        badge.textContent = 'Owned';
                        btn.parentNode.insertBefore(badge, btn);
                    }
                    
                    btn.textContent = 'Owned';
                    btn.disabled = true;
                    card.setAttribute('data-unlocked', 'true');
                    card.setAttribute('data-owned', 'true');
                    
                    showShopMessage('Purchase successful!', false);
                } else {
                    // Handle unsuccessful response
                    throw new Error(data.message || 'Purchase failed');
                }
            })
            .catch(function(err) {
                console.error('Shop purchase error:', err);
                
                // Reset button state
                btn.disabled = false;
                btn.textContent = originalText;
                btn.dataset.processing = 'false';
                
                // Show user-friendly error message
                var errorMessage = 'An error occurred while processing your purchase.';
                if (err.message) {
                    errorMessage = err.message;
                }
                showShopMessage('Error: ' + errorMessage, true);
            });
        });
    })();
</script>
{% endblock %} 