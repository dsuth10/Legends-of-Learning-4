{% extends "student/base_student.html" %}

{% block title %}Quests{% endblock %}

{% block content %}
<div class="h-screen flex flex-col overflow-hidden">
    {# Include shared header and clan bar #}
    {% include "student/_student_header.html" %}
    
    {# Main content area #}
    <div class="flex-1 flex overflow-hidden relative">
        {# Background image #}
        <div class="absolute inset-0 z-0">
            <img alt="Fantasy Landscape Background" class="w-full h-full object-cover filter brightness-[0.7]" 
                 src="{{ url_for('static', filename='images/quest_maps/quest_map.png') or 'https://via.placeholder.com/1920x1080?text=Background' }}">
            <div class="absolute inset-0 bg-white/10 dark:bg-black/50"></div>
        </div>
        
        {# Quest Log Sidebar #}
        <aside class="w-80 z-10 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm border-r border-gray-200 dark:border-gray-700 flex flex-col h-full overflow-y-auto custom-scrollbar shadow-2xl">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 sticky top-0 z-10">
                <h2 class="font-display text-2xl font-bold text-gray-800 dark:text-gray-100 flex items-center">
                    <span class="material-symbols-outlined mr-2 text-primary">menu_book</span>
                    Quest Log
                </h2>
            </div>
            
            <div class="p-4 space-y-4">
                {% for quest_data in assigned_quests %}
                    {% set quest = quest_data.quest %}
                    {% set log = quest_data.log %}
                    {% set status = quest_data.status %}
                    {% set progress_percent = quest_data.progress_percent %}
                    
                    {% set status_class = 'border-primary hover:bg-indigo-50 dark:hover:bg-gray-700' %}
                    {% set status_badge_class = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400 border border-yellow-200 dark:border-yellow-800' %}
                    {% set status_text = 'Active' %}
                    {% set progress_color = 'bg-primary' %}
                    {% set progress_text = 'Progress: ' + progress_percent|string + '%' %}
                    
                    {% if status.value == 'completed' %}
                        {% set status_class = 'border-green-500 hover:bg-green-50 dark:hover:bg-gray-700 opacity-80 hover:opacity-100' %}
                        {% set status_badge_class = 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400 border border-green-200 dark:border-green-800' %}
                        {% set status_text = 'Ready' %}
                        {% set progress_color = 'bg-green-500' %}
                        {% set progress_text = 'Completed! Return to turn in.' %}
                    {% elif status.value == 'not_started' %}
                        {% set status_class = 'border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 opacity-60 hover:opacity-100' %}
                        {% set status_badge_class = 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 border border-gray-200 dark:border-gray-600' %}
                        {% set status_text = 'New' %}
                        {% set progress_color = 'bg-gray-400' %}
                        {% set progress_text = 'Not started' %}
                    {% endif %}
                    
                    <div class="quest-card group relative bg-white dark:bg-gray-800 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all border-l-4 {{ status_class }} shadow-sm" 
                         data-quest-id="{{ quest.id }}"
                         onclick="selectQuest({{ quest.id }})">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-800 dark:text-gray-100 text-sm">{{ quest.name }}</h3>
                            <span class="text-[10px] px-2 py-0.5 rounded-full {{ status_badge_class }} font-semibold">{{ status_text }}</span>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2 mb-3">{{ quest.description or 'No description available.' }}</p>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mb-1">
                            <div class="{{ progress_color }} h-1.5 rounded-full" style="width: {{ progress_percent }}%"></div>
                        </div>
                        <span class="text-[10px] {% if status.value == 'completed' %}text-green-600 dark:text-green-400{% else %}text-gray-400{% endif %} font-medium">{{ progress_text }}</span>
                    </div>
                {% endfor %}
                
                {% if assigned_quests|length == 0 %}
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <p class="text-sm">No quests assigned yet.</p>
                    </div>
                {% endif %}
            </div>
            
            <div class="mt-auto p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
                <button class="w-full py-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 flex items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors font-bold text-sm" disabled>
                    <span class="material-icons mr-2 text-sm">filter_list</span>
                    Filter Quests
                </button>
            </div>
        </aside>
        
        {# Main Quest Details Area #}
        <main class="flex-1 relative z-10 flex flex-col p-8 overflow-y-auto">
            {% if assigned_quests|length > 0 %}
                {% set selected_quest_data = assigned_quests[0] %}
                {% set selected_quest = selected_quest_data.quest %}
                {% set selected_log = selected_quest_data.log %}
                {% set selected_status = selected_quest_data.status %}
                {% set selected_objectives = selected_quest_data.objectives %}
                {% set selected_rewards_xp = selected_quest_data.rewards_xp %}
                {% set selected_rewards_gold = selected_quest_data.rewards_gold %}
                {% set selected_rewards_items = selected_quest_data.rewards_items %}
                {% set selected_time_remaining = selected_quest_data.time_remaining %}
                {% set selected_quest_type = selected_quest_data.quest_type_display %}
                
                <div class="max-w-4xl mx-auto w-full bg-white/95 dark:bg-gray-900/95 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-700 flex flex-col md:flex-row h-full md:h-auto min-h-[600px]">
                    {# Main quest content #}
                    <div class="p-8 flex-1 flex flex-col">
                        {# Quest header #}
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="px-3 py-1 rounded-full bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 text-xs font-bold uppercase tracking-wider border border-indigo-200 dark:border-indigo-700">{{ selected_quest_type or 'Story Quest' }}</span>
                                    {% if selected_time_remaining %}
                                        <span class="text-gray-400 text-sm flex items-center">
                                            <span class="material-icons text-sm mr-1">schedule</span> {{ selected_time_remaining }}
                                        </span>
                                    {% endif %}
                                </div>
                                <h1 class="font-display text-4xl font-bold text-gray-800 dark:text-gray-100 mb-2">{{ selected_quest.name }}</h1>
                                <p class="text-gray-600 dark:text-gray-300 text-lg italic border-l-4 border-primary pl-4 py-1 mb-6 bg-gray-50 dark:bg-gray-800/50">
                                    "{{ selected_quest.description or 'No description available.' }}"
                                </p>
                            </div>
                            <div class="hidden md:block">
                                <div class="w-20 h-20 bg-indigo-100 dark:bg-indigo-900/50 rounded-full flex items-center justify-center border-4 border-white dark:border-gray-700 shadow-lg">
                                    <span class="material-icons text-4xl text-primary">auto_stories</span>
                                </div>
                            </div>
                        </div>
                        
                        {# Objectives and Rewards #}
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            {# Objectives List #}
                            <div>
                                <h3 class="font-display text-lg font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                    <span class="material-icons mr-2 text-primary">check_circle</span>
                                    Objectives
                                </h3>
                                <ul class="space-y-4">
                                    {% for obj in selected_objectives %}
                                        {% set obj_id = obj.get('id', loop.index) %}
                                        {% set obj_text = obj.get('text', 'Objective ' + obj_id|string) %}
                                        {% set obj_completed = obj.get('completed', False) %}
                                        
                                        <li class="flex items-start">
                                            {% if obj_completed %}
                                                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white text-xs mr-3 mt-0.5 shadow-md">
                                                    <span class="material-icons text-sm">check</span>
                                                </div>
                                                <span class="text-gray-600 dark:text-gray-300 line-through">{{ obj_text }}</span>
                                            {% elif selected_status.value == 'in_progress' %}
                                                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-white dark:bg-gray-800 border-2 border-primary flex items-center justify-center text-primary text-xs mr-3 mt-0.5 shadow-md">
                                                    <span class="font-bold">{{ obj_id }}</span>
                                                </div>
                                                <span class="text-gray-800 dark:text-gray-200 font-medium">{{ obj_text }}</span>
                                            {% else %}
                                                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-500 text-xs mr-3 mt-0.5">
                                                    <span class="font-bold">{{ obj_id }}</span>
                                                </div>
                                                <span class="text-gray-500 dark:text-gray-400">{{ obj_text }}</span>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            
                            {# Rewards Section #}
                            <div>
                                <h3 class="font-display text-lg font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                    <span class="material-icons mr-2 text-xp-yellow">emoji_events</span>
                                    Rewards
                                </h3>
                                <div class="grid grid-cols-2 gap-3">
                                    {% if selected_rewards_xp > 0 %}
                                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl border border-gray-200 dark:border-gray-700 flex items-center space-x-3">
                                            <div class="w-10 h-10 rounded-full bg-xp-yellow/20 flex items-center justify-center text-xp-yellow">
                                                <span class="material-icons">star</span>
                                            </div>
                                            <div>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold">Experience</p>
                                                <p class="font-bold text-gray-800 dark:text-white">+ {{ "{:,}".format(selected_rewards_xp) }} XP</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if selected_rewards_gold > 0 %}
                                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl border border-gray-200 dark:border-gray-700 flex items-center space-x-3">
                                            <div class="w-10 h-10 rounded-full bg-gp-gold/20 flex items-center justify-center text-gp-gold">
                                                <span class="material-icons">monetization_on</span>
                                            </div>
                                            <div>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold">Gold</p>
                                                <p class="font-bold text-gray-800 dark:text-white">+ {{ "{:,}".format(selected_rewards_gold) }} GP</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if selected_rewards_items|length > 0 %}
                                        {% for item_reward in selected_rewards_items %}
                                            <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl border border-gray-200 dark:border-gray-700 flex items-center space-x-3 col-span-2">
                                                <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400">
                                                    <span class="material-icons">school</span>
                                                </div>
                                                <div>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold">Item</p>
                                                    <p class="font-bold text-gray-800 dark:text-white">{{ item_reward.item_name or 'Quest Item' }}</p>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                    {% if selected_rewards_xp == 0 and selected_rewards_gold == 0 and selected_rewards_items|length == 0 %}
                                        <div class="col-span-2 text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
                                            No rewards specified
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {# Action Buttons #}
                        <div class="mt-auto flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                            {% if selected_status.value == 'in_progress' %}
                                <button class="flex-1 bg-primary hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:-translate-y-0.5 flex items-center justify-center">
                                    <span class="material-icons mr-2">play_arrow</span>
                                    Continue Quest
                                </button>
                            {% elif selected_status.value == 'not_started' %}
                                <form method="POST" action="{{ url_for('student.start_quest', quest_id=selected_quest.id) }}" class="flex-1">
                                    <button type="submit" class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:-translate-y-0.5 flex items-center justify-center">
                                        <span class="material-icons mr-2">play_arrow</span>
                                        Start Quest
                                    </button>
                                </form>
                            {% elif selected_status.value == 'completed' %}
                                <form method="POST" action="{{ url_for('student.complete_quest', quest_id=selected_quest.id) }}" class="flex-1">
                                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:-translate-y-0.5 flex items-center justify-center">
                                        <span class="material-icons mr-2">check_circle</span>
                                        Turn In
                                    </button>
                                </form>
                            {% endif %}
                            <button class="px-6 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" disabled>
                                Abandon
                            </button>
                        </div>
                    </div>
                    
                    {# Quest Giver Info Sidebar #}
                    <div class="w-full md:w-80 bg-gray-50 dark:bg-gray-800/50 border-t md:border-t-0 md:border-l border-gray-200 dark:border-gray-700 p-6 flex flex-col">
                        <h3 class="font-display text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-4">Quest Giver</h3>
                        <div class="flex items-center mb-6">
                            <img alt="Quest Giver" class="w-16 h-16 rounded-full border-2 border-white dark:border-gray-600 shadow-md object-cover mr-4" 
                                 src="{{ url_for('static', filename='avatars/default.png') }}">
                            <div>
                                <p class="font-bold text-gray-800 dark:text-white">Master Archivist</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Library of Alexandria</p>
                            </div>
                        </div>
                        <h3 class="font-display text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-4">Related Lore</h3>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm mb-6">
                            <div class="flex items-start space-x-3">
                                <span class="material-icons text-amber-500 mt-1">lightbulb</span>
                                <p class="text-sm text-gray-600 dark:text-gray-300 italic">
                                    "{{ selected_quest.description or 'Complete this quest to unlock new adventures.' }}"
                                </p>
                            </div>
                        </div>
                        <div class="mt-auto bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                            <h4 class="font-bold text-blue-800 dark:text-blue-300 text-sm mb-1">Tip</h4>
                            <p class="text-xs text-blue-600 dark:text-blue-400">
                                Check your objectives regularly to track your progress.
                            </p>
                        </div>
                    </div>
                </div>
            {% else %}
                {# Empty state #}
                <div class="max-w-4xl mx-auto w-full bg-white/95 dark:bg-gray-900/95 backdrop-blur-md rounded-2xl shadow-2xl p-12 text-center">
                    <span class="material-icons text-6xl text-gray-400 mb-4">menu_book</span>
                    <h2 class="font-display text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">No Quests Available</h2>
                    <p class="text-gray-600 dark:text-gray-400">Your teacher hasn't assigned any quests yet.</p>
                </div>
            {% endif %}
        </main>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function selectQuest(questId) {
    // Update active quest card
    document.querySelectorAll('.quest-card').forEach(card => {
        card.classList.remove('ring-2', 'ring-primary');
    });
    event.currentTarget.classList.add('ring-2', 'ring-primary');
    
    // In a full implementation, you would fetch and update the quest details
    // For now, we'll just highlight the selected card
    // The page will show the first quest by default
}
</script>
{% endblock %}
