{% extends "base.html" %}

{% block title %}Character{% endblock %}

{% block content %}
<div class="container mt-5">
    {% if main_character %}
        <h2 class="mb-4">Your Character</h2>
        <div class="row">
            <div class="col-md-3">
                <img src="{{ main_character.avatar_url }}" alt="Avatar" class="img-thumbnail mb-3" style="width:128px;height:128px;">
            </div>
            <div class="col-md-9">
                <table class="table table-bordered w-auto">
                    <tr><th>Name</th><td id="char-name">{{ main_character.name }}</td></tr>
                    <tr><th>Class</th><td>{{ main_character.character_class }}</td></tr>
                    <tr><th>Gender</th><td>{{ main_character.gender }}</td></tr>
                    <tr><th>Level</th><td id="char-level">{{ main_character.level }}</td></tr>
                    <tr><th>XP</th><td id="char-xp">{{ main_character.experience }}</td></tr>
                    <tr><th>Health</th><td id="char-health">{{ main_character.total_health }} <span class="text-muted small">(Base: {{ main_character.health }})</span></td></tr>
                    <tr><th>Power</th><td id="char-power">{{ main_character.total_power }} <span class="text-muted small">(Base: {{ main_character.power }})</span></td></tr>
                    <tr><th>Defense</th><td id="char-defense">{{ main_character.total_defense }} <span class="text-muted small">(Base: {{ main_character.defense }})</span></td></tr>
                    <tr><th>Gold</th><td id="char-gold">{{ main_character.gold }}</td></tr>
                </table>
                {% if active_status_effects %}
                <h5 class="mt-3">Active Status Effects</h5>
                <div id="status-effects-display" class="mb-3">
                  {% for effect in active_status_effects %}
                    <span class="status-effect-badge {{ effect.effect_type }}" title="{{ effect.source }}: {{ effect.stat_affected }} {{ '+' if effect.amount > 0 else '' }}{{ effect.amount }} (expires {{ effect.expires_at.strftime('%H:%M') }})">
                      {% if effect.effect_type == 'buff' %}â¬†ï¸{% elif effect.effect_type == 'debuff' %}â¬‡ï¸{% elif effect.effect_type == 'protect' %}ðŸ›¡ï¸{% endif %}
                      {{ effect.source }} ({{ effect.stat_affected }} {{ '+' if effect.amount > 0 else '' }}{{ effect.amount }})
                      <small class="text-muted">({{ effect.remaining_minutes }}m)</small>
                    </span>
                  {% endfor %}
                </div>
                {% endif %}
                <h4>Equipment Slots</h4>
                <div class="row mb-3">
                  <div class="col-md-4">
                    <h6>Weapon</h6>
                    <ul class="equipment-slot-list list-group" id="weapon-slot" data-slot="weapon">
                      {% if main_character.equipped_weapon %}
                        <li class="equipment-item list-group-item" data-id="{{ main_character.equipped_weapon.id }}" data-slot="weapon" title="{{ main_character.equipped_weapon.equipment.description }} | +H:{{ main_character.equipped_weapon.equipment.health_bonus }} +S:{{ main_character.equipped_weapon.equipment.power_bonus }} +D:{{ main_character.equipped_weapon.equipment.defense_bonus }}">
                          <img src="{{ main_character.equipped_weapon.equipment.image_url or '/static/images/default_item.png' }}" alt="{{ main_character.equipped_weapon.equipment.name }}" style="width:32px;height:32px;margin-right:8px;vertical-align:middle;">
                          {{ main_character.equipped_weapon.equipment.name }}
                        </li>
                      {% endif %}
                    </ul>
                  </div>
                  <div class="col-md-4">
                    <h6>Armor</h6>
                    <ul class="equipment-slot-list list-group" id="armor-slot" data-slot="armor">
                      {% if main_character.equipped_armor %}
                        <li class="equipment-item list-group-item" data-id="{{ main_character.equipped_armor.id }}" data-slot="armor" title="{{ main_character.equipped_armor.equipment.description }} | +H:{{ main_character.equipped_armor.equipment.health_bonus }} +S:{{ main_character.equipped_armor.equipment.power_bonus }} +D:{{ main_character.equipped_armor.equipment.defense_bonus }}">
                          <img src="{{ main_character.equipped_armor.equipment.image_url or '/static/images/default_item.png' }}" alt="{{ main_character.equipped_armor.equipment.name }}" style="width:32px;height:32px;margin-right:8px;vertical-align:middle;">
                          {{ main_character.equipped_armor.equipment.name }}
                        </li>
                      {% endif %}
                    </ul>
                  </div>
                  <div class="col-md-4">
                    <h6>Accessory</h6>
                    <ul class="equipment-slot-list list-group" id="accessory-slot" data-slot="accessory">
                      {% if main_character.equipped_accessory %}
                        <li class="equipment-item list-group-item" data-id="{{ main_character.equipped_accessory.id }}" data-slot="accessory" title="{{ main_character.equipped_accessory.equipment.description }} | +H:{{ main_character.equipped_accessory.equipment.health_bonus }} +S:{{ main_character.equipped_accessory.equipment.power_bonus }} +D:{{ main_character.equipped_accessory.equipment.defense_bonus }}">
                          <img src="{{ main_character.equipped_accessory.equipment.image_url or '/static/images/default_item.png' }}" alt="{{ main_character.equipped_accessory.equipment.name }}" style="width:32px;height:32px;margin-right:8px;vertical-align:middle;">
                          {{ main_character.equipped_accessory.equipment.name }}
                        </li>
                      {% endif %}
                    </ul>
                  </div>
                </div>
                <h4>Inventory (Unequipped Items)</h4>
                <ul class="list-group mb-3" id="inventory-list">
                  {% for item in main_character.inventory_items if not item.is_equipped %}
                    <li class="equipment-item list-group-item" data-id="{{ item.id }}" data-slot="{{ item.equipment.slot }}" title="{{ item.equipment.description }} | +H:{{ item.equipment.health_bonus }} +S:{{ item.equipment.power_bonus }} +D:{{ item.equipment.defense_bonus }}">
                      <img src="{{ item.equipment.image_url or '/static/images/default_item.png' }}" alt="{{ item.equipment.name }}" style="width:32px;height:32px;margin-right:8px;vertical-align:middle;">
                      {{ item.equipment.name }}
                    </li>
                  {% else %}
                    <li class="list-group-item text-muted">No unequipped items in inventory.</li>
                  {% endfor %}
                </ul>
                <span id="inventory-msg"></span>
                <form method="POST" action="{{ url_for('student.gain_xp') }}">
                    <button type="submit" class="btn btn-warning">Gain 500 XP (Test Level Up)</button>
                </form>
                <h4>Equipped Abilities</h4>
                <div id="abilities-section">
                  {% if equipped_abilities %}
                    <ul class="list-group mb-3">
                      {% for ab in equipped_abilities %}
                        {% set cooldown_remaining = 0 %}
                        {% if ab.last_used_at and ab.cooldown %}
                          {% set used_ts = ab.last_used_at | todatetime('utc') | unixtimestamp %}
                          {% set cooldown_remaining = (used_ts + ab.cooldown) - now %}
                          {% if cooldown_remaining < 0 %}{% set cooldown_remaining = 0 %}{% endif %}
                        {% endif %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          <div>
                            <strong>{{ ab.name }}</strong> <span class="badge bg-info">{{ ab.type }}</span><br>
                            <span class="text-muted small">{{ ab.description }}</span><br>
                            <span class="text-muted">Power: {{ ab.power }} | Cooldown: {{ ab.cooldown }}s</span>
                          </div>
                          <div class="d-flex align-items-center flex-wrap">
                            <div class="me-2 mb-2">
                              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#target-select-{{ ab.id }}" aria-expanded="false">
                                Select Target <i class="bi bi-chevron-down"></i>
                              </button>
                              <div class="collapse mt-2" id="target-select-{{ ab.id }}">
                                <div class="card card-body p-2" style="max-width: 300px;">
                                  <div class="target-selection-card mb-2 p-2 border rounded" data-target-id="{{ main_character.id }}" data-ability-id="{{ ab.id }}" style="cursor: pointer;">
                                    <div class="d-flex align-items-center">
                                      <img src="{{ main_character.avatar_url or '/static/avatars/default.png' }}" alt="Avatar" class="rounded me-2" style="width: 40px; height: 40px;">
                                      <div class="flex-grow-1">
                                        <strong>{{ main_character.name }}</strong> (Self)<br>
                                        <small class="text-muted">{{ main_character.character_class }} | HP: {{ main_character.health }}/{{ main_character.max_health }}</small>
                                      </div>
                                    </div>
                                  </div>
                                  {% for t in ability_targets %}
                                    <div class="target-selection-card mb-2 p-2 border rounded" data-target-id="{{ t.id }}" data-ability-id="{{ ab.id }}" style="cursor: pointer;">
                                      <div class="d-flex align-items-center">
                                        <div class="bg-secondary rounded me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; color: white;">
                                          {{ t.name[0] }}
                                        </div>
                                        <div class="flex-grow-1">
                                          <strong>{{ t.name }}</strong><br>
                                          <small class="text-muted">{{ t.character_class }}</small>
                                        </div>
                                      </div>
                                    </div>
                                  {% endfor %}
                                </div>
                              </div>
                              <input type="hidden" class="ability-target-select" data-ability-id="{{ ab.id }}" value="{{ main_character.id }}">
                            </div>
                            <button class="btn btn-primary use-ability-btn" data-ability-id="{{ ab.id }}" data-cooldown="{{ cooldown_remaining }}" {% if cooldown_remaining > 0 %}disabled{% endif %}>
                              {% if cooldown_remaining > 0 %}
                                Cooldown: <span class="cooldown-timer">{{ cooldown_remaining }}</span>s
                              {% else %}
                                Use
                              {% endif %}
                            </button>
                          </div>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <div class="text-muted">No abilities equipped.</div>
                  {% endif %}
                  <div id="ability-feedback" class="mt-2"></div>
                </div>
                <h4 class="mt-4">Ability History</h4>
                <div id="ability-history-section">
                  <div class="mb-2">
                    <select id="history-filter-type" class="form-select form-select-sm d-inline-block" style="width: auto;">
                      <option value="">All Types</option>
                      <option value="heal">Heal</option>
                      <option value="attack">Attack</option>
                      <option value="buff">Buff</option>
                      <option value="debuff">Debuff</option>
                      <option value="defense">Defense</option>
                      <option value="utility">Utility</option>
                    </select>
                    <select id="history-filter-days" class="form-select form-select-sm d-inline-block ms-2" style="width: auto;">
                      <option value="1">Last 24 hours</option>
                      <option value="7" selected>Last 7 days</option>
                      <option value="30">Last 30 days</option>
                    </select>
                    <button id="refresh-history" class="btn btn-sm btn-secondary ms-2">Refresh</button>
                  </div>
                  <div id="ability-history-list" class="list-group" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-muted text-center py-3">Loading history...</div>
                  </div>
                </div>
            </div>
        </div>
        <p>View and customize your character, equipment, and abilities here.</p>
        <!-- Add character info, equipment, and abilities here -->
    {% else %}
        <div class="alert alert-info">You have not created a character yet.</div>
        <a href="{{ url_for('student.character_create') }}" class="btn btn-success">Create Your Character</a>
    {% endif %}
</div>
<!-- Add SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
function equipHandler(slot) {
  return function(evt) {
    const itemId = evt.item.dataset.id;
    const itemSlot = evt.item.dataset.slot;
    fetch('/student/equipment/equip', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ inventory_id: itemId, slot: itemSlot })
    })
    .then(r => r.json())
    .then(resp => {
      if (!resp.success) {
        evt.from.appendChild(evt.item);
        alert(resp.message || 'Error equipping item');
      } else {
        window.location.reload();
      }
    });
  }
}
function unequipHandler(evt) {
  const itemId = evt.item.dataset.id;
  fetch('/student/equipment/unequip', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ inventory_id: itemId })
  })
  .then(r => r.json())
  .then(resp => {
    if (!resp.success) {
      evt.from.appendChild(evt.item);
      alert(resp.message || 'Error unequipping item');
    } else {
      window.location.reload();
    }
  });
}
Sortable.create(document.getElementById('inventory-list'), {
  group: 'equipment',
  animation: 150,
  sort: false,
  onAdd: unequipHandler
});
Sortable.create(document.getElementById('weapon-slot'), {
  group: 'equipment',
  animation: 150,
  sort: false,
  onAdd: equipHandler('weapon')
});
Sortable.create(document.getElementById('armor-slot'), {
  group: 'equipment',
  animation: 150,
  sort: false,
  onAdd: equipHandler('armor')
});
Sortable.create(document.getElementById('accessory-slot'), {
  group: 'equipment',
  animation: 150,
  sort: false,
  onAdd: equipHandler('accessory')
});
</script>
{% endblock %}

{% block super_extra_js %}
<script src="{{ url_for('static', filename='js/abilities.js') }}"></script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
const MAIN_CHARACTER_ID = {{ main_character.id if main_character else 0 }};

function updateCooldownTimers() {
  document.querySelectorAll('.use-ability-btn').forEach(function(btn) {
    var cooldown = parseInt(btn.getAttribute('data-cooldown'));
    if (cooldown > 0) {
      var timerSpan = btn.querySelector('.cooldown-timer');
      if (timerSpan) {
        cooldown--;
        btn.setAttribute('data-cooldown', cooldown);
        timerSpan.textContent = cooldown;
        if (cooldown <= 0) {
          btn.disabled = false;
          btn.innerHTML = 'Use';
        }
      }
    }
  });
}
setInterval(updateCooldownTimers, 1000);

document.addEventListener('DOMContentLoaded', function() {
  // Handle target selection cards
  document.querySelectorAll('.target-selection-card').forEach(function(card) {
    card.addEventListener('click', function() {
      const targetId = this.dataset.targetId;
      const abilityId = this.dataset.abilityId;
      
      // Update hidden input
      const targetInput = document.querySelector(`.ability-target-select[data-ability-id="${abilityId}"]`);
      if (targetInput) {
        targetInput.value = targetId;
      }
      
      // Update visual selection
      document.querySelectorAll(`.target-selection-card[data-ability-id="${abilityId}"]`).forEach(function(c) {
        c.classList.remove('selected');
      });
      this.classList.add('selected');
      
      // Close collapse
      const collapse = document.getElementById(`target-select-${abilityId}`);
      if (collapse) {
        const bsCollapse = bootstrap.Collapse.getInstance(collapse);
        if (bsCollapse) {
          bsCollapse.hide();
        }
      }
    });
  });
  
  document.querySelectorAll('.use-ability-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const btnElement = this;
      const abilityId = btnElement.dataset.abilityId;
      const targetSelect = document.querySelector('.ability-target-select[data-ability-id="' + abilityId + '"]');
      const targetId = targetSelect ? targetSelect.value : MAIN_CHARACTER_ID;
      const abilityName = btnElement.closest('.list-group-item').querySelector('strong').textContent;
      
      // Disable button during request
      btnElement.disabled = true;
      btnElement.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Using...';
      
      fetch('/student/abilities/use', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ability_id: abilityId, target_id: targetId, context: 'general' })
      })
      .then(r => r.json())
      .then(resp => {
        // Show visual feedback
        showAbilityFeedback(resp, abilityName, resp.target?.name || 'target');
        
        if (resp.success) {
          // Update character stats without reload
          if (resp.character) {
            updateCharacterStats(resp.character, resp.target, resp.effect);
          }
          
          // Update cooldown
          if (resp.cooldown !== undefined) {
            updateAbilityCooldown(abilityId, resp.cooldown);
          }
          
          // Refresh status effects if available
          if (resp.target && resp.target.status_effects) {
            // Status effects will be updated on next page load or via separate API call
          }
        } else {
          // Re-enable button on error
          btnElement.disabled = false;
          btnElement.innerHTML = 'Use';
        }
      })
      .catch(error => {
        console.error('Error using ability:', error);
        showAbilityFeedback({success: false, message: 'An error occurred. Please try again.'}, abilityName, '');
        btnElement.disabled = false;
        btnElement.innerHTML = 'Use';
      });
    });
  });
  
  // Load ability history
  function loadAbilityHistory() {
    const typeFilter = document.getElementById('history-filter-type').value;
    const daysFilter = document.getElementById('history-filter-days').value;
    const historyList = document.getElementById('ability-history-list');
    
    historyList.innerHTML = '<div class="text-muted text-center py-3">Loading...</div>';
    
    let url = '/student/abilities/history?limit=20&days=' + daysFilter;
    if (typeFilter) {
      url += '&type=' + typeFilter;
    }
    
    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (data.success && data.history && data.history.length > 0) {
          historyList.innerHTML = data.history.map(item => {
            const icon = item.ability_type === 'heal' ? 'ðŸ’š' : 
                        item.ability_type === 'attack' ? 'âš”ï¸' :
                        item.ability_type === 'buff' ? 'â¬†ï¸' :
                        item.ability_type === 'debuff' ? 'â¬‡ï¸' :
                        item.ability_type === 'defense' ? 'ðŸ›¡ï¸' : 'âœ¨';
            const timestamp = new Date(item.timestamp);
            const timeStr = timestamp.toLocaleString();
            const xpText = item.xp_awarded > 0 ? ` <span class="text-success">(+${item.xp_awarded} XP)</span>` : '';
            const successClass = item.success ? '' : 'text-muted';
            
            return `
              <div class="list-group-item ${successClass}">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong>${icon} ${item.ability_name}</strong>
                    <span class="badge bg-secondary ms-2">${item.ability_type}</span>
                    <br>
                    <small class="text-muted">Used on ${item.target_name} | ${item.effect_type}: ${item.effect_amount > 0 ? '+' : ''}${item.effect_amount}${xpText}</small>
                    ${item.context !== 'general' ? `<br><small class="text-info">Context: ${item.context}</small>` : ''}
                  </div>
                  <small class="text-muted">${timeStr}</small>
                </div>
              </div>
            `;
          }).join('');
        } else {
          historyList.innerHTML = '<div class="text-muted text-center py-3">No ability usage history found.</div>';
        }
      })
      .catch(error => {
        console.error('Error loading history:', error);
        historyList.innerHTML = '<div class="text-danger text-center py-3">Error loading history.</div>';
      });
  }
  
  // Load history on page load
  loadAbilityHistory();
  
  // Refresh button
  document.getElementById('refresh-history')?.addEventListener('click', loadAbilityHistory);
  
  // Filter changes
  document.getElementById('history-filter-type')?.addEventListener('change', loadAbilityHistory);
  document.getElementById('history-filter-days')?.addEventListener('change', loadAbilityHistory);
});
</script>
{% endblock %} 