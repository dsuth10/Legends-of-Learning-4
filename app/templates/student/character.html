{% extends "base.html" %}

{% block title %}Character{% endblock %}

{% block content %}
<div class="container mt-5">
    {% if main_character %}
        <h2 class="mb-4">Your Character</h2>
        <div class="row">
            <div class="col-md-3">
                <img src="{{ main_character.avatar_url }}" alt="Avatar" class="img-thumbnail mb-3" style="width:128px;height:128px;">
            </div>
            <div class="col-md-9">
                <table class="table table-bordered w-auto">
                    <tr><th>Name</th><td>{{ main_character.name }}</td></tr>
                    <tr><th>Class</th><td>{{ main_character.character_class }}</td></tr>
                    <tr><th>Gender</th><td>{{ main_character.gender }}</td></tr>
                    <tr><th>Level</th><td>{{ main_character.level }}</td></tr>
                    <tr><th>XP</th><td>{{ main_character.experience }}</td></tr>
                    <tr><th>Health</th><td>{{ main_character.total_health }} <span class="text-muted small">(Base: {{ main_character.health }})</span></td></tr>
                    <tr><th>Strength</th><td>{{ main_character.total_strength }} <span class="text-muted small">(Base: {{ main_character.strength }})</span></td></tr>
                    <tr><th>Defense</th><td>{{ main_character.total_defense }} <span class="text-muted small">(Base: {{ main_character.defense }})</span></td></tr>
                    <tr><th>Gold</th><td>{{ main_character.gold }}</td></tr>
                </table>
                <h4>Equipment Slots</h4>
                <div class="row mb-3">
                  <div class="col-md-4">
                    <h6>Weapon</h6>
                    <ul class="equipment-slot-list list-group" id="weapon-slot" data-slot="weapon">
                      {% if main_character.equipped_weapon %}
                        <li class="equipment-item list-group-item" data-id="{{ main_character.equipped_weapon.id }}" data-slot="weapon" title="{{ main_character.equipped_weapon.equipment.description }} | +H:{{ main_character.equipped_weapon.equipment.health_bonus }} +S:{{ main_character.equipped_weapon.equipment.strength_bonus }} +D:{{ main_character.equipped_weapon.equipment.defense_bonus }}">
                          <img src="{{ main_character.equipped_weapon.equipment.image_url or '/static/images/default_item.png' }}" alt="{{ main_character.equipped_weapon.equipment.name }}" style="width:32px;height:32px;margin-right:8px;vertical-align:middle;">
                          {{ main_character.equipped_weapon.equipment.name }}
                        </li>
                      {% endif %}
                    </ul>
                  </div>
                  <div class="col-md-4">
                    <h6>Armor</h6>
                    <ul class="equipment-slot-list list-group" id="armor-slot" data-slot="armor">
                      {% if main_character.equipped_armor %}
                        <li class="equipment-item list-group-item" data-id="{{ main_character.equipped_armor.id }}" data-slot="armor" title="{{ main_character.equipped_armor.equipment.description }} | +H:{{ main_character.equipped_armor.equipment.health_bonus }} +S:{{ main_character.equipped_armor.equipment.strength_bonus }} +D:{{ main_character.equipped_armor.equipment.defense_bonus }}">
                          <img src="{{ main_character.equipped_armor.equipment.image_url or '/static/images/default_item.png' }}" alt="{{ main_character.equipped_armor.equipment.name }}" style="width:32px;height:32px;margin-right:8px;vertical-align:middle;">
                          {{ main_character.equipped_armor.equipment.name }}
                        </li>
                      {% endif %}
                    </ul>
                  </div>
                  <div class="col-md-4">
                    <h6>Accessory</h6>
                    <ul class="equipment-slot-list list-group" id="accessory-slot" data-slot="accessory">
                      {% if main_character.equipped_accessory %}
                        <li class="equipment-item list-group-item" data-id="{{ main_character.equipped_accessory.id }}" data-slot="accessory" title="{{ main_character.equipped_accessory.equipment.description }} | +H:{{ main_character.equipped_accessory.equipment.health_bonus }} +S:{{ main_character.equipped_accessory.equipment.strength_bonus }} +D:{{ main_character.equipped_accessory.equipment.defense_bonus }}">
                          <img src="{{ main_character.equipped_accessory.equipment.image_url or '/static/images/default_item.png' }}" alt="{{ main_character.equipped_accessory.equipment.name }}" style="width:32px;height:32px;margin-right:8px;vertical-align:middle;">
                          {{ main_character.equipped_accessory.equipment.name }}
                        </li>
                      {% endif %}
                    </ul>
                  </div>
                </div>
                <h4>Inventory (Unequipped Items)</h4>
                <ul class="list-group mb-3" id="inventory-list">
                  {% for item in main_character.inventory_items if not item.is_equipped %}
                    <li class="equipment-item list-group-item" data-id="{{ item.id }}" data-slot="{{ item.equipment.type.value }}" title="{{ item.equipment.description }} | +H:{{ item.equipment.health_bonus }} +S:{{ item.equipment.strength_bonus }} +D:{{ item.equipment.defense_bonus }}">
                      <img src="{{ item.equipment.image_url or '/static/images/default_item.png' }}" alt="{{ item.equipment.name }}" style="width:32px;height:32px;margin-right:8px;vertical-align:middle;">
                      {{ item.equipment.name }}
                    </li>
                  {% else %}
                    <li class="list-group-item text-muted">No unequipped items in inventory.</li>
                  {% endfor %}
                </ul>
                <span id="inventory-msg"></span>
                <form method="POST" action="{{ url_for('student.gain_xp') }}">
                    <button type="submit" class="btn btn-warning">Gain 500 XP (Test Level Up)</button>
                </form>
            </div>
        </div>
        <p>View and customize your character, equipment, and abilities here.</p>
        <!-- Add character info, equipment, and abilities here -->
    {% else %}
        <div class="alert alert-info">You have not created a character yet.</div>
        <a href="{{ url_for('student.character_create') }}" class="btn btn-success">Create Your Character</a>
    {% endif %}
</div>
<!-- Add SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
function equipHandler(slot) {
  return function(evt) {
    const itemId = evt.item.dataset.id;
    const itemSlot = evt.item.dataset.slot;
    if (itemSlot !== slot) {
      evt.from.appendChild(evt.item);
      alert(`You can only equip ${slot} items in the ${slot} slot.`);
      return;
    }
    fetch('/student/equipment/equip', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ inventory_id: itemId, slot: slot })
    })
    .then(r => r.json())
    .then(resp => {
      if (!resp.success) {
        evt.from.appendChild(evt.item);
        alert(resp.message || 'Error equipping item');
      } else {
        window.location.reload();
      }
    });
  }
}
function unequipHandler(evt) {
  const itemId = evt.item.dataset.id;
  fetch('/student/equipment/unequip', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ inventory_id: itemId })
  })
  .then(r => r.json())
  .then(resp => {
    if (!resp.success) {
      evt.from.appendChild(evt.item);
      alert(resp.message || 'Error unequipping item');
    } else {
      window.location.reload();
    }
  });
}
Sortable.create(document.getElementById('inventory-list'), {
  group: 'equipment',
  animation: 150,
  sort: false,
  onAdd: unequipHandler
});
Sortable.create(document.getElementById('weapon-slot'), {
  group: 'equipment',
  animation: 150,
  sort: false,
  onAdd: equipHandler('weapon')
});
Sortable.create(document.getElementById('armor-slot'), {
  group: 'equipment',
  animation: 150,
  sort: false,
  onAdd: equipHandler('armor')
});
Sortable.create(document.getElementById('accessory-slot'), {
  group: 'equipment',
  animation: 150,
  sort: false,
  onAdd: equipHandler('accessory')
});
</script>
{% endblock %} 