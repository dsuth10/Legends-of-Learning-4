{% extends "base.html" %}

{% block title %}Quests{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Your Quests</h2>
    <div class="mb-3">Click a location on the map to view quest details and take action.</div>
    <div class="quest-map position-relative mb-4" style="background: url('{{ url_for('static', filename='images/quest_maps/quest_map.png') }}') no-repeat center center; background-size: cover; width: 100%; max-width: 900px; height: 600px; margin: 0 auto; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.15);">
        {% set max_x = 9 %}
        {% set max_y = 9 %}
        {% for q in assigned_quests %}
            {% set status = q.status.value if q.status.value is defined else q.status %}
            {% if q.x is not none and q.y is not none %}
                {% set left = (q.x / max_x * 100) ~ '%' %}
                {% set top = (q.y / max_y * 100) ~ '%' %}
                <div class="quest-marker position-absolute" style="top:{{ top }}; left:{{ left }};">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#questModal{{ q.quest.id }}"
                       class="fw-bold {% if status == 'completed' %}completed-quest{% elif status == 'in_progress' %}active-quest{% else %}available-quest{% endif %}">
                        {{ q.quest.title }}
                        {% if status == 'completed' %}
                            <span title="Completed">✔️</span>
                        {% elif status == 'in_progress' %}
                            <span title="Active">(Active)</span>
                        {% endif %}
                    </a>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    <!-- Modals for each quest -->
    {% for q in assigned_quests %}
    {% set status = q.status.value if q.status.value is defined else q.status %}
    <div class="modal fade" id="questModal{{ q.quest.id }}" tabindex="-1" aria-labelledby="questModalLabel{{ q.quest.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="questModalLabel{{ q.quest.id }}">{{ q.quest.title }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>{{ q.quest.description }}</p>
            <p><strong>Rewards:</strong>
                {{ q.quest.rewards.filter_by(type='gold').first().amount if q.quest.rewards.filter_by(type='gold').first() else 0 }} Gold,
                {{ q.quest.rewards.filter_by(type='experience').first().amount if q.quest.rewards.filter_by(type='experience').first() else 0 }} XP
            </p>
            {% if status == 'completed' %}
              <p class="text-success"><em>This quest is completed.</em></p>
            {% elif status == 'in_progress' %}
              <p class="text-info"><em>This quest is in progress.</em></p>
              {% if equipped_abilities %}
              <hr>
              <h6>Use Abilities</h6>
              <div id="quest-ability-section-{{ q.quest.id }}" class="quest-ability-section">
                <div class="list-group list-group-flush">
                  {% for ab in equipped_abilities %}
                    {% set cooldown_remaining = 0 %}
                    {% if ab.last_used_at %}
                      {% set used_ts = ab.last_used_at | todatetime('utc') | unixtimestamp %}
                      {% set cooldown_remaining = (used_ts + ab.cooldown) - now %}
                      {% if cooldown_remaining < 0 %}{% set cooldown_remaining = 0 %}{% endif %}
                    {% endif %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div class="flex-grow-1">
                        <strong>{{ ab.name }}</strong> <span class="badge bg-info">{{ ab.type }}</span><br>
                        <small class="text-muted">{{ ab.description }}</small>
                      </div>
                      <div class="ms-2">
                        <select class="form-select form-select-sm ability-target-select-quest" style="width: auto;" data-ability-id="{{ ab.id }}" data-quest-id="{{ q.quest.id }}">
                          <option value="{{ main_character.id if main_character else '' }}">Self</option>
                          {% for t in ability_targets %}
                            <option value="{{ t.id }}">{{ t.name }}</option>
                          {% endfor %}
                        </select>
                        <button class="btn btn-sm btn-primary use-ability-quest-btn mt-1" 
                                data-ability-id="{{ ab.id }}" 
                                data-quest-id="{{ q.quest.id }}"
                                data-cooldown="{{ cooldown_remaining }}"
                                {% if cooldown_remaining > 0 %}disabled{% endif %}>
                          {% if cooldown_remaining > 0 %}
                            <span class="cooldown-timer">{{ cooldown_remaining }}</span>s
                          {% else %}
                            Use
                          {% endif %}
                        </button>
                      </div>
                    </div>
                  {% endfor %}
                </div>
                <div id="quest-ability-feedback-{{ q.quest.id }}" class="mt-2"></div>
              </div>
              {% endif %}
            {% endif %}
          </div>
          <div class="modal-footer">
            {% if status == 'not_started' %}
              <form method="post" action="{{ url_for('student.start_quest', quest_id=q.quest.id) }}">
                <button type="submit" class="btn btn-success">Start Quest</button>
              </form>
            {% elif status == 'in_progress' %}
              <form method="post" action="{{ url_for('student.complete_quest', quest_id=q.quest.id) }}">
                <button type="submit" class="btn btn-primary">Mark Complete</button>
              </form>
            {% else %}
              <button class="btn btn-secondary" disabled>Completed</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    <!-- Optional: List active and completed quests below the map for clarity -->
    <div class="row mt-4">
      <div class="col-md-6">
        <h5>Active Quests</h5>
        <ul>
        {% set found_active = false %}
        {% for q in assigned_quests %}
          {% set status = q.status.value if q.status.value is defined else q.status %}
          {% if status == 'in_progress' %}
            <li>{{ q.quest.title }}</li>
            {% set found_active = true %}
          {% endif %}
        {% endfor %}
        {% if not found_active %}
          <li class="text-muted">No active quests.</li>
        {% endif %}
        </ul>
      </div>
      <div class="col-md-6">
        <h5>Completed Quests</h5>
        <ul>
        {% set found_completed = false %}
        {% for q in assigned_quests %}
          {% set status = q.status.value if q.status.value is defined else q.status %}
          {% if status == 'completed' %}
            <li>{{ q.quest.title }}</li>
            {% set found_completed = true %}
          {% endif %}
        {% endfor %}
        {% if not found_completed %}
          <li class="text-muted">No completed quests.</li>
        {% endif %}
        </ul>
      </div>
    </div>
</div>
{% endblock %}

{% block super_extra_js %}
<script src="{{ url_for('static', filename='js/abilities.js') }}"></script>
{% endblock %}

{% block super_extra_css %}
<style>
.quest-map { position: relative; overflow: hidden; }
.quest-marker { z-index: 2; }
.quest-marker a { text-shadow: 1px 1px 2px #000, 0 0 6px #fff; font-size: 1.1rem; padding: 4px 10px; border-radius: 6px; background: rgba(0,0,0,0.18); }
.quest-marker a.available-quest { color: #ffc107; border-bottom: 2px solid #ffc107; }
.quest-marker a.active-quest { color: #17a2b8; border-bottom: 2px solid #17a2b8; }
.quest-marker a.completed-quest { color: #aaa; text-decoration: line-through; border-bottom: 2px solid #aaa; opacity: 0.7; }
.quest-marker a:hover { background: rgba(255,255,255,0.18); }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
const MAIN_CHARACTER_ID_QUESTS = {{ main_character.id if main_character else 0 }};

// Update cooldown timers for quest abilities
function updateQuestCooldownTimers() {
  document.querySelectorAll('.use-ability-quest-btn').forEach(function(btn) {
    var cooldown = parseInt(btn.getAttribute('data-cooldown'));
    if (cooldown > 0) {
      cooldown--;
      btn.setAttribute('data-cooldown', cooldown);
      const timerSpan = btn.querySelector('.cooldown-timer');
      if (timerSpan) {
        timerSpan.textContent = cooldown;
      }
      if (cooldown <= 0) {
        btn.disabled = false;
        btn.innerHTML = 'Use';
      }
    }
  });
}
setInterval(updateQuestCooldownTimers, 1000);

// Handle ability usage in quest context
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.use-ability-quest-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const btnElement = this;
      const abilityId = btnElement.dataset.abilityId;
      const questId = btnElement.dataset.questId;
      const targetSelect = document.querySelector(`.ability-target-select-quest[data-ability-id="${abilityId}"][data-quest-id="${questId}"]`);
      const targetId = targetSelect ? targetSelect.value : MAIN_CHARACTER_ID_QUESTS;
      const feedbackDiv = document.getElementById(`quest-ability-feedback-${questId}`);
      
      btnElement.disabled = true;
      btnElement.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
      
      fetch('/student/abilities/use', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ability_id: abilityId, target_id: targetId, context: 'quest' })
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.success) {
          if (feedbackDiv) {
            feedbackDiv.innerHTML = `<div class="alert alert-success alert-sm">${resp.message}</div>`;
            setTimeout(() => { feedbackDiv.innerHTML = ''; }, 3000);
          }
          if (resp.cooldown !== undefined) {
            updateAbilityCooldown(abilityId, resp.cooldown);
            btnElement.setAttribute('data-cooldown', resp.cooldown);
            if (resp.cooldown > 0) {
              btnElement.disabled = true;
              btnElement.innerHTML = `<span class="cooldown-timer">${resp.cooldown}</span>s`;
            } else {
              btnElement.disabled = false;
              btnElement.innerHTML = 'Use';
            }
          }
        } else {
          if (feedbackDiv) {
            feedbackDiv.innerHTML = `<div class="alert alert-danger alert-sm">${resp.message}</div>`;
            setTimeout(() => { feedbackDiv.innerHTML = ''; }, 3000);
          }
          btnElement.disabled = false;
          btnElement.innerHTML = 'Use';
        }
      })
      .catch(error => {
        console.error('Error using ability in quest:', error);
        if (feedbackDiv) {
          feedbackDiv.innerHTML = '<div class="alert alert-danger alert-sm">Error using ability.</div>';
          setTimeout(() => { feedbackDiv.innerHTML = ''; }, 3000);
        }
        btnElement.disabled = false;
        btnElement.innerHTML = 'Use';
      });
    });
  });
});
</script>
{% endblock %} 